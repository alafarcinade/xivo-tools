#!/bin/bash
release="squeeze-dahdi-linux-2.6.0"
mirror="deb http://mirror.xivo.fr/archive/ $release main"
mirror_file="/etc/apt/sources.list.d/$release.list"
apt_preferences_file="/etc/apt/preferences.d/dahdi"
packages="dahdi dahdi-linux dahdi-linux-modules-$(uname -r)"

usage() {
    cat << EOF
    This script is usefull to downgrade dahdi-linux on xivo

    usage: $0 action
    
    availables actions:
        install: to install dahdi-2.6.0
        remove:  to remove dahdi-2.6.0
EOF
}

show_installed_version() {
    echo "#### Installed versions ####"
    echo
    for package in $packages; do
        version=$(apt-cache policy $package | grep Installed | grep -oE '2\.[2-9]\.[0-9]{1,2}' | head -n 1)
        echo "$package: $version"
    done
}

install_dahdi() {
    read -p 'Would you like to downgrade dahdi (service will be restarted) [Y/n]? ' answer                                                                                        
    answer="${answer:-Y}"                                                                                                                                                                  
    if [ "$answer" != 'y' -a "$answer" != 'Y' ]; then                                                                                                                                      
        exit                                                                                                                                                                               
    fi                                                  
    if [ ! -f $mirror_file ]; then
        echo $mirror > $mirror_file
        apt-get update > /dev/null
    fi
    if [ ! -f $apt_preferences_file ]; then
        for package in $packages; do
            cat >> $apt_preferences_file << EOF
Package: $package
Pin: release a=$release
Pin-Priority: 1001
EOF
        done
    fi
    rep=$(mktemp -d)
    cd $rep
    apt-get update > /dev/null
    aptitude download $packages -t $release
    dpkg -i dahdi*deb
    cd - && rm -rf $rep
    service dahdi restart
    show_installed_version
}

remove_dahdi() {
    if [ -f $mirror_file ]; then
        rm $mirror_file
    fi
    if [ -f $apt_preferences_file ]; then
        rm $apt_preferences_file
    fi
    xivo-upgrade
    show_installed_version
}

case $1 in
    install) install_dahdi;;
    remove)  remove_dahdi;;
    *) usage;;
esac
